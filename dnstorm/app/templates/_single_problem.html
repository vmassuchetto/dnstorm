{% extends "_base.html" %}
{% load crispy_forms_tags i18n captureas %}

{% block head %}
    {{ form.media }}
    <script type="text/javascript">
        var problem_id = {{ problem.id }};
    </script>
{% endblock %}

{% block bodyclass %}problem{% endblock %}

{% block modals %}
    {% if problem_perm_contribute %}

        {# Alternative removal confirmation #}

        <div id="alternative-delete-modal" class="reveal-modal tiny" data-reveal>
            <div class="row">
            <div class="columns large-12">
                <p>{% trans "Really remove this alternative?" %}</p>
            </div>
            </div>
            <div class="row">
            <div class="columns large-6">
                <a class="close-reveal-modal-button button small secondary radius no-margin-bottom">{% trans "Cancel" %}</a>
            </div>
            <div class="columns large-6 text-right">
                <a class="delete button alert radius no-margin-bottom delete-alternative-confirm">{% trans "Remove!" %}</a>
            </div>
            </div>
        </div>

        {# Edit alternatives #}

        <div id="alternative-edit" class="reveal-modal large" data-reveal>
            <a class="close-reveal-modal">&#215;</a>
            <h3>{% trans "Edit alternative" %}</h3>
            <form>
                {% crispy alternative_form %}
                <hr/>
                <div class="row">
                    <div class="large-12 text-right">
                        <a class="button success radius alternative-save">{% trans "Save" %}</a>
                    </div>
                </div>
            </form>
        </div>

    {% endif %}

    {% if problem_perm_contribute %}
        <div class="hide" id="comment-form">{% crispy comment_form %}</div>
    {% endif %}

{% endblock %}

{% block messages %}

    {# Draft mode #}

    {% if not problem.published %}
        {% url "problem_update" problem.id problem.slug as problem_update_url %}
        {% captureas message %}
            {% blocktrans %}This is a preview mode from an unpublished draft. The problem is not available for user contribution until it is published. <a class="left-1em button secondary tiny radius" href="{{ problem_update_url }}">Edit problem</a>{% endblocktrans %}
        {% endcaptureas %}
        {% include "part_message.html" with icon="page-edit" message=message %}
    {% endif %}

{% endblock %}

{% block content %}

    <div class="row collapse">
    <div class="columns large-12 problem-detail">

        {# Description #}

        <div class="problem-tab problem-description">
            {% include "item_problem.html" %}
        </div>

        {# Criteria #}

        <div class="problem-tab problem-criteria">

            {% if problem_perm_contribute %}
                <a class="button radius large-icon large-button text-left expand" href="{% url "criteria_create" problem.id %}"><i class="fi-plus"></i>{% trans "Click here to insert a new criteria." %}</a>
            {% endif %}

            {% if criteria %}
                {% for c in criteria %}
                    {% include "item_criteria.html" with criteria=c show_actions=False show_parameters=True show_icons=True show_description=True show_comments=True %}
                {% endfor %}
            {% else %}
                {% trans "There's no criteria defined for this problem yet." as message %}
                {% include "part_panel.html" with icon="prohibited" message=message %}
            {% endif %}

        </div>

        {# Ideas list #}

        <div class="problem-tab problem-ideas">

            {% if problem.criteria_set.all|length > 0 %}

                {% if problem_perm_contribute %}
                    <a class="button radius large-icon large-button text-left expand" href="{% url "idea_create" problem.id %}"><i class="fi-plus"></i>{% trans "Click here to insert a new idea." %}</a>
                {% endif %}

                {% if ideas %}
                    {% for idea in ideas %}
                        {% include "item_idea.html" with show_likes=True show_actions=True show_comments=True %}
                    {% endfor %}
                {% endif %}

            {% else %}
                {% trans "Ideas submission will be available when criteria are defined." as message %}
                {% include "part_panel.html" with icon="prohibited" message=message %}
            {% endif %}
        </div>

        {# Alternatives #}

        <div class="problem-tab problem-alternatives">

            {% if problem.criteria_set.all|length > 0 and ideas %}

                {% if problem_perm_contribute %}
                    <a class="button radius large-icon large-button text-left expand" href="{% url "alternative_create" problem.id %}"><i class="fi-plus"></i>{% trans "Click here to insert a new alternative." %}</a>
                {% endif %}

                {% if alternatives %}
                    {% for alternative in alternatives %}
                        {% include "item_alternative.html" %}
                    {% endfor %}
                {% else %}
                    {% trans "There's no alternative created yet." as message %}
                    {% include "part_panel.html" with icon="prohibited" message=message %}
                {% endif %}

            {% else %}
                {% trans "Alternatives will be available when there's criteria and ideas." as message %}
                {% include "part_panel.html" with icon="prohibited" message=message %}
            {% endif %}

        </div>

        {# Results #}

        <div class="problem-tab problem-results">
            <script type="text/javascript">
                Chart.defaults.global.scaleIntegersOnly = false;
            </script>
            <div class="inner-tab text-center">
                <h3>{% trans "Alternative preference from users" %}</h3>
                {% if alternatives %}
                    {% for alternative in alternatives %}
                        {% include "item_alternative.html" with mode="result" %}
                    {% endfor %}
                {% else %}
                    {% trans "There's no alternative to render data yet." as message %}
                    {% include "part_panel.html" with icon="prohibited" message=message %}
                {% endif %}
                <h3>{% trans "Criteria attendance from alternatives" %}</h3>
                {% if problem.criteria_results %}
                    {% for result in problem.criteria_results %}
                        <div class="row">
                            <div class="columns large-4">{% include "item_criteria.html" with criteria=result.criteria show_actions=False show_parameters=True show_icons=True show_description=True show_comments=False %}</h4></div>
                            <div class="columns large-8 text-left">
                                <canvas id="criteria-chart-{{ result.criteria.id }}" class="criteria-chart"></canvas>
                            </div>
                            <script type="text/javascript">
                                var data = {
                                    labels: [{% for alternative in result.alternatives %}'{{ alternative.name }}'{% if not forloop.last %},{% endif %}{% endfor %}],
                                    datasets: [{
                                        label: "{% trans "Alternatives" %}",
                                        data: [{% for alternative in result.alternatives %}parseFloat({{ alternative.value }}){% if not forloop.last %},{% endif %}{% endfor %}]
                                    }]
                                };
                                var context = document.getElementById('criteria-chart-{{ result.criteria.id }}').getContext('2d');
                                var options = {
                                    animationSteps: 20,
                                    scaleShowValues: true,
                                    tooltipTemplate: "<%= value %>"
                                }
                                var chart = new Chart(context).Bar(data, options);
                            </script>
                        </div>
                    {% endfor %}
                {% else %}
                    {% captureas message %}
                        {% blocktrans %}There's not enough data to show criteria results.{% endblocktrans %}
                    {% endcaptureas %}
                    {% include "part_panel.html" with icon="prohibited" message=message %}
                {% endif %}
            </div>
        </div>

    </div>
    </div>


{% endblock %}
